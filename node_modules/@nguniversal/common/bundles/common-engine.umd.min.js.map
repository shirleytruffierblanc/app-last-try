{"version":3,"sources":["modules/common/common-engine.umd.js"],"names":["global","factory","exports","module","require","define","amd","nguniversal","common","engine","fs","ng","compiler","core","platformServer","this","FileLoader","prototype","get","url","Promise","resolve","reject","readFile","err","buffer","toString","__read","o","n","m","Symbol","iterator","r","e","i","call","ar","next","done","push","value","error","CommonEngine","moduleOrFactory","providers","factoryCacheMap","Map","templateCache","getCompiler","platformDynamicServer","injector","CompilerFactory","createCompiler","provide","ResourceLoader","useClass","deps","render","opts","thisArg","generator","_a","extraProviders","body","f","y","t","g","_","label","sent","trys","ops","verb","throw","return","v","step","op","TypeError","pop","length","__generator","_b","document","getDocument","documentFilePath","arguments","concat","__spread","INITIAL_CONFIG","useValue","getFactory","renderModuleFactory","P","fulfilled","rejected","result","then","apply","_this","NgModuleFactory","moduleFactory","compileModuleAsync","set","filePath","doc","readFileSync","ɵFileLoader","ɵCommonEngine","Object","defineProperty"],"mappings":"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","sourcesContent":["(function (global, factory) {\n\ttypeof exports === 'object' && typeof module !== 'undefined' ? factory(exports, require('fs'), require('@angular/compiler'), require('@angular/core'), require('@angular/platform-server')) :\n\ttypeof define === 'function' && define.amd ? define('@nguniversal/common/engine', ['exports', 'fs', '@angular/compiler', '@angular/core', '@angular/platform-server'], factory) :\n\t(factory((global.nguniversal = global.nguniversal || {}, global.nguniversal.common = global.nguniversal.common || {}, global.nguniversal.common.engine = {}),global.fs,global.ng.compiler,global.ng.core,global.ng.platformServer));\n}(this, (function (exports,fs,compiler,core,platformServer) { 'use strict';\n\n/**\n * @license\n * Copyright Google LLC All Rights Reserved.\n *\n * Use of this source code is governed by an MIT-style license that can be\n * found in the LICENSE file at https://angular.io/license\n */\n/** ResourceLoader implementation for loading files */\nvar FileLoader = /** @class */ (function () {\n    function FileLoader() {\n    }\n    FileLoader.prototype.get = function (url) {\n        return new Promise(function (resolve, reject) {\n            fs.readFile(url, function (err, buffer) {\n                if (err) {\n                    return reject(err);\n                }\n                resolve(buffer.toString());\n            });\n        });\n    };\n    return FileLoader;\n}());\n\nvar __awaiter = (undefined && undefined.__awaiter) || function (thisArg, _arguments, P, generator) {\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nvar __generator = (undefined && undefined.__generator) || function (thisArg, body) {\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\n    function verb(n) { return function (v) { return step([n, v]); }; }\n    function step(op) {\n        if (f) throw new TypeError(\"Generator is already executing.\");\n        while (_) try {\n            if (f = 1, y && (t = y[op[0] & 2 ? \"return\" : op[0] ? \"throw\" : \"next\"]) && !(t = t.call(y, op[1])).done) return t;\n            if (y = 0, t) op = [0, t.value];\n            switch (op[0]) {\n                case 0: case 1: t = op; break;\n                case 4: _.label++; return { value: op[1], done: false };\n                case 5: _.label++; y = op[1]; op = [0]; continue;\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\n                default:\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\n                    if (t[2]) _.ops.pop();\n                    _.trys.pop(); continue;\n            }\n            op = body.call(thisArg, _);\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\n    }\n};\nvar __read = (undefined && undefined.__read) || function (o, n) {\n    var m = typeof Symbol === \"function\" && o[Symbol.iterator];\n    if (!m) return o;\n    var i = m.call(o), r, ar = [], e;\n    try {\n        while ((n === void 0 || n-- > 0) && !(r = i.next()).done) ar.push(r.value);\n    }\n    catch (error) { e = { error: error }; }\n    finally {\n        try {\n            if (r && !r.done && (m = i[\"return\"])) m.call(i);\n        }\n        finally { if (e) throw e.error; }\n    }\n    return ar;\n};\nvar __spread = (undefined && undefined.__spread) || function () {\n    for (var ar = [], i = 0; i < arguments.length; i++) ar = ar.concat(__read(arguments[i]));\n    return ar;\n};\n/**\n * @license\n * Copyright Google LLC All Rights Reserved.\n *\n * Use of this source code is governed by an MIT-style license that can be\n * found in the LICENSE file at https://angular.io/license\n */\n/**\n * A common rendering engine utility. This abstracts the logic\n * for handling the platformServer compiler, the module cache, and\n * the document loader\n */\nvar CommonEngine = /** @class */ (function () {\n    function CommonEngine(moduleOrFactory, providers) {\n        if (providers === void 0) { providers = []; }\n        this.moduleOrFactory = moduleOrFactory;\n        this.providers = providers;\n        this.factoryCacheMap = new Map();\n        this.templateCache = {};\n    }\n    /** Return an instance of the platformServer compiler */\n    CommonEngine.prototype.getCompiler = function () {\n        var compilerFactory = platformServer.platformDynamicServer().injector.get(core.CompilerFactory);\n        return compilerFactory.createCompiler([\n            { providers: [{ provide: compiler.ResourceLoader, useClass: FileLoader, deps: [] }] }\n        ]);\n    };\n    /**\n     * Render an HTML document for a specific URL with specified\n     * render options\n     */\n    CommonEngine.prototype.render = function (opts) {\n        return __awaiter(this, void 0, void 0, function () {\n            var doc, _a, extraProviders, factory;\n            return __generator(this, function (_b) {\n                switch (_b.label) {\n                    case 0:\n                        _a = opts.document;\n                        if (_a) return [3 /*break*/, 2];\n                        return [4 /*yield*/, this.getDocument(opts.documentFilePath)];\n                    case 1:\n                        _a = (_b.sent());\n                        _b.label = 2;\n                    case 2:\n                        doc = _a;\n                        extraProviders = __spread((opts.providers || []), (this.providers || []), [\n                            {\n                                provide: platformServer.INITIAL_CONFIG,\n                                useValue: {\n                                    document: doc,\n                                    url: opts.url\n                                }\n                            }\n                        ]);\n                        return [4 /*yield*/, this.getFactory()];\n                    case 3:\n                        factory = _b.sent();\n                        return [2 /*return*/, platformServer.renderModuleFactory(factory, { extraProviders: extraProviders })];\n                }\n            });\n        });\n    };\n    /** Return the factory for a given engine instance */\n    CommonEngine.prototype.getFactory = function () {\n        var _this = this;\n        // If module has been compiled AoT\n        var moduleOrFactory = this.moduleOrFactory;\n        if (moduleOrFactory instanceof core.NgModuleFactory) {\n            return Promise.resolve(moduleOrFactory);\n        }\n        else {\n            // we're in JIT mode\n            var moduleFactory = this.factoryCacheMap.get(moduleOrFactory);\n            // If module factory is cached\n            if (moduleFactory) {\n                return Promise.resolve(moduleFactory);\n            }\n            // Compile the module and cache it\n            return this.getCompiler().compileModuleAsync(moduleOrFactory)\n                .then(function (factory) {\n                _this.factoryCacheMap.set(moduleOrFactory, factory);\n                return factory;\n            });\n        }\n    };\n    /** Retrieve the document from the cache or the filesystem */\n    CommonEngine.prototype.getDocument = function (filePath) {\n        var doc = this.templateCache[filePath] = this.templateCache[filePath] ||\n            fs.readFileSync(filePath).toString();\n        // As  promise so we can change the API later without breaking\n        return Promise.resolve(doc);\n    };\n    return CommonEngine;\n}());\n\n/**\n * @license\n * Copyright Google LLC All Rights Reserved.\n *\n * Use of this source code is governed by an MIT-style license that can be\n * found in the LICENSE file at https://angular.io/license\n */\n\n/**\n * @license\n * Copyright Google LLC All Rights Reserved.\n *\n * Use of this source code is governed by an MIT-style license that can be\n * found in the LICENSE file at https://angular.io/license\n */\n\n/**\n * @license\n * Copyright Google LLC All Rights Reserved.\n *\n * Use of this source code is governed by an MIT-style license that can be\n * found in the LICENSE file at https://angular.io/license\n */\n\n/**\n * Generated bundle index. Do not edit.\n */\n\nexports.ɵFileLoader = FileLoader;\nexports.ɵCommonEngine = CommonEngine;\n\nObject.defineProperty(exports, '__esModule', { value: true });\n\n})));\n//# sourceMappingURL=common-engine.umd.js.map\n"]}